<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
  <meta charset="UTF-8">
  <title>Faculty Dashboard | LeavePortal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="styles.css">
  <script>
    tailwind.config = {
      darkMode: ['class', '[data-theme="dark"]'],
      theme: {
        extend: {
          colors: {
            primary: "var(--primary)",
            secondary: "var(--secondary)",
            bgbase: "var(--bg-body)",
            card: "var(--bg-card)",
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          }
        },
      },
    };
  </script>
</head>

<body class="bg-bgbase text-[var(--text-main)] min-h-screen">

  <!-- Navbar -->
  <header class="glass-header sticky top-0 z-50">
    <nav class="max-w-7xl mx-auto px-6 h-16 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center text-white font-bold text-lg">
          F
        </div>
        <span class="text-lg font-bold">Faculty<span class="text-primary">Portal</span></span>
      </div>

      <button onclick="logout()"
        class="text-sm font-medium text-[var(--text-muted)] hover:text-red-500 transition-colors flex items-center gap-2">
        <span>Logout</span>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
        </svg>
      </button>
    </nav>
  </header>

  <main class="max-w-7xl mx-auto px-6 py-8 animate-fade-in">

    <div class="mb-8 flex flex-col md:flex-row justify-between items-end gap-4">
      <div>
        <h1 class="text-2xl font-bold mb-1">Leave Requests Review</h1>
        <p class="text-[var(--text-muted)]">Manage incoming student applications.</p>
      </div>
    </div>

    <!-- Active Request Section -->
    <div id="loading" class="text-center py-20 text-[var(--text-muted)]">
      Loading requests...
    </div>

    <div id="noData" class="card p-12 text-center hidden">
      <div class="w-16 h-16 bg-[var(--bg-body)] rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-8 h-8 text-[var(--text-muted)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
      </div>
      <h3 class="text-lg font-bold mb-1">All Caught Up!</h3>
      <p class="text-[var(--text-muted)]">There are no pending leave requests at the moment.</p>
    </div>

    <div id="requestsContainer" class="space-y-6 hidden">
      <!-- Dynamic Cards will be injected here -->
    </div>
  </main>

  <button class="theme-toggle" onclick="toggleTheme()">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z">
      </path>
    </svg>
  </button>

  <script>
    // Theme Logic
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);

    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
    }

    const teacherId = "T101";

    // Template for a request card
    function createRequestCard(leave) {
      return `
        <div class="card p-6 md:p-8 animate-slide-up flex flex-col gap-6">
            <!-- Header -->
            <div class="flex flex-wrap justify-between items-start gap-4 pb-6 border-b border-[var(--border-color)]">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 flex items-center justify-center font-bold text-lg">
                        ${leave.studentName.charAt(0)}
                    </div>
                    <div>
                        <h3 class="font-bold text-lg">${leave.studentName}</h3>
                        <p class="text-sm text-[var(--text-muted)]">${leave.studentId} â€¢ ${leave.className || 'Class N/A'}</p>
                    </div>
                </div>
                
                <div class="flex gap-8 text-right">
                    <div>
                        <p class="text-xs uppercase tracking-wider font-bold text-[var(--text-muted)] mb-1">Attendance</p>
                        <p class="text-xl font-bold ${leave.attendance < 75 ? 'text-red-500' : 'text-emerald-500'}">${leave.attendance}%</p>
                    </div>
                    <div>
                        <p class="text-xs uppercase tracking-wider font-bold text-[var(--text-muted)] mb-1">SEM %</p>
                        <p class="text-xl font-bold text-primary">${leave.semPercentage}</p>
                    </div>
                </div>
            </div>

            <!-- Body -->
            <div class="grid md:grid-cols-2 gap-8">
                 <div>
                    <h4 class="text-xs uppercase font-bold text-[var(--text-muted)] mb-2">Leave Details</h4>
                    <div class="bg-[var(--bg-body)] p-4 rounded-lg space-y-2">
                        <div class="flex justify-between">
                            <span class="text-sm text-[var(--text-muted)]">Type</span>
                            <span class="font-medium capitalize">${leave.leaveType}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-[var(--text-muted)]">Duration</span>
                            <span class="font-medium">${leave.totalDays} Days (${leave.startDate} - ${leave.endDate})</span>
                        </div>
                    </div>
                 </div>
                 
                 <div>
                    <h4 class="text-xs uppercase font-bold text-[var(--text-muted)] mb-2">Reason</h4>
                    <p class="text-sm italic leading-relaxed text-[var(--text-main)] w-full p-4 bg-[var(--bg-body)] rounded-lg min-h-[6rem]">
                        "${leave.reason}"
                    </p>
                 </div>
            </div>

            <!-- Footer / Actions -->
            <div class="flex gap-4 pt-2 justify-end">
                <button onclick="processLeave(${leave.id}, 'rejected')" class="px-6 py-2.5 rounded-lg border border-red-200 text-red-600 font-medium hover:bg-red-50 dark:border-red-900/30 dark:hover:bg-red-900/10 transition-colors">
                    Reject Request
                </button>
                <button onclick="processLeave(${leave.id}, 'approved')" class="px-6 py-2.5 rounded-lg bg-primary text-white font-medium hover:bg-blue-600 transition-colors shadow-sm">
                    Approve Request
                </button>
            </div>
        </div>
        `;
    }

    async function loadLeaves() {
      const container = document.getElementById("requestsContainer");
      const loading = document.getElementById("loading");
      const noData = document.getElementById("noData");

      try {
        const res = await fetch(`http://localhost:3000/api/leave/requests?teacherId=${teacherId}`);
        const data = await res.json();

        loading.classList.add("hidden");

        // Filter pending
        const pending = data.filter(l => l.status === "pending");

        if (pending.length === 0) {
          container.innerHTML = "";
          noData.classList.remove("hidden");
          container.classList.add("hidden");
        } else {
          noData.classList.add("hidden");
          container.classList.remove("hidden");
          container.innerHTML = pending.map(leave => createRequestCard(leave)).join('');
        }

      } catch (err) {
        console.error(err);
        loading.textContent = "Error loading data. Is backend running?";
      }
    }

    async function processLeave(id, action) {
      if (!confirm(`Are you sure you want to ${action} this request?`)) return;

      try {
        const res = await fetch(`http://localhost:3000/api/leave/requests/${id}/process`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action,
            teacherId,
            comment: action === "approved" ? "Approved" : "Rejected"
          })
        });

        if (res.ok) {
          loadLeaves(); // Refresh
        } else {
          alert("Error processing request");
        }
      } catch (err) {
        alert("Server connection error");
      }
    }

    function logout() {
      window.location.href = "landingpage.html";
    }

    loadLeaves();
  </script>
</body>

</html>